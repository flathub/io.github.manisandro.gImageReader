app-id: io.github.manisandro.gImageReader
runtime: org.gnome.Platform
# runtime 45 causes application crashes: https://github.com/flathub/io.github.manisandro.gImageReader/issues/31
runtime-version: '48'
sdk: org.gnome.Sdk
command: gimagereader-gtk
rename-desktop-file: gimagereader-gtk.desktop
rename-appdata-file: gimagereader-gtk.appdata.xml
rename-icon: gimagereader
add-extensions:
  io.github.manisandro.gImageReader.tessdata:
    directory: share/tessdata
    version: 4.1.0
    bundle: true

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --talk-name=org.a11y.Bus
  - --own-name=org.gnome.gimagereader.*
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfsd
  - --env=TESSDATA_PREFIX=/app/share
  # Filesystem access
  # for Open
  # for Add Image/Add another image
  # for Add Folder
  # for Import PDF
  # for Save
  # for Save as...
  # for Export
  # for Append Project
  # for Export to ODT
  - --filesystem=home
  # Scanners access
  - --device=all

cleanup:
  - /include
  - /lib/atkmm-1.6
  - /lib/cmake
  - /lib/cairomm-1.0
  - /lib/girepository-1.0
  - /lib/gdkmm-3.0
  - /lib/giomm-2.4
  - /lib/glibmm-2.4
  - /lib/gtkmm-3.0
  - /lib/libglibmm_generate_extra_defs*
  - /lib/openjpeg-*
  - /lib/pangomm-1.4
  - /lib/pkgconfig
  - /lib/sigc++-2.0
  - /man
  - /share/aclocal
  - /share/doc
  - /share/gir-1.0
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - /share/vala
  - '*.la'
  - '*.a'

modules:
  - name: gimagereader
    buildsystem: cmake-ninja
    config-opts:
      - -DINTERFACE_TYPE=gtk
      - -DENABLE_VERSIONCHECK=0
    post-install:
      # Use the SVG icon instead for clearity
      - install -Dm644 data/icons/gimagereader.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/gimagereader.svg"
    modules:
      - shared-modules/intltool/intltool-0.51.json

      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=/app --with-libraries=system
          - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
        sources:
          - type: archive
            url: https://archives.boost.io/release/1.89.0/source/boost_1_89_0.tar.bz2
            sha256: 85a33fa22621b4f314f8e85e1a5e2a9363d22e4f4992925d4bb3bc631b5a0c7a
            x-checker-data:
              type: anitya
              project-id: 6845
              stable-only: true
              url-template: https://archives.boost.io/release/$version/source/boost_${major}_${minor}_$patch.tar.bz2

      - name: mm-common
        sources:
          - type: archive
            url: https://download.gnome.org/sources/mm-common/1.0/mm-common-1.0.7.tar.xz
            sha256: 494abfce781418259b1e9d8888c73af4de4b6f3be36cc75d9baa8baa0f2a7a39
            x-checker-data:
              type: gnome
              name: mm-common
              stable-only: true

      - name: sane-backends
        buildsystem: autotools
        config-opts:
          - --disable-saned
        post-install:
          - rm /app/etc/sane.d/dll.conf
          - rm /app/etc/sane.d/net.conf
          - echo 127.0.0.1 > /app/etc/sane.d/net.conf
          - echo net > /app/etc/sane.d/dll.conf
          - echo escl >> /app/etc/sane.d/dll.conf
          - echo airscan >> /app/etc/sane.d/dll.conf
        sources:
          - type: git
            url: https://gitlab.com/sane-project/backends.git
            tag: 1.4.0
            commit: c7e4b5e35e3d614d2b1181d760a717bfc395a203
            x-checker-data:
              type: anitya
              project-id: 4760
              tag-template: $version

      - name: podofo
        buildsystem: cmake-ninja
        builddir: true
        cleanup:
          - /bin
          - /share
        config-opts:
          - -DPODOFO_BUILD_LIB_ONLY=1
        sources:
          - type: archive
            url: https://github.com/podofo/podofo/archive/refs/tags/1.0.1.tar.gz
            sha256: 188316124627a68feeb0636697f907f2cd13f48bdef7eca5fc8492f9c53ce012
            x-checker-data:
              type: anitya
              project-id: 10527
              url-template: https://github.com/podofo/podofo/archive/refs/tags/$version.tar.gz

      - name: djvulibre
        sources:
          - type: archive
            url: https://downloads.sourceforge.net/djvu/djvulibre-3.5.29.tar.gz
            sha256: d3b4b03ae2bdca8516a36ef6eb27b777f0528c9eda26745d9962824a3fdfeccf
            x-checker-data:
              type: anitya
              project-id: 10159
              stable-only: true
              url-template: https://downloads.sourceforge.net/djvu/djvulibre-$version.tar.gz

        # https://github.com/flathub/org.gnome.Gnote/blob/11d75091558cef2cc9658a04da7ad71d63581d3f/gtkmm.json#L3
        # NB: all versions are pinned below a coordinated ABI break
      - name: gtkmm
        sources:
          - sha256: 7ab7e2266808716e26c39924ace1fb46da86c17ef39d989624c42314b32b5a76
            type: archive
            url: https://download.gnome.org/sources/gtkmm/3.24/gtkmm-3.24.10.tar.xz
            x-checker-data:
              type: gnome
              name: gtkmm
              versions:
                <: '3.25'
        buildsystem: meson
        config-opts:
          - -Dmaintainer-mode=false
          - -Dbuild-demos=false
          - -Dbuild-tests=false
        modules:
          - name: sigc++
            sources:
              - sha256: 235a40bec7346c7b82b6a8caae0456353dc06e71f14bc414bcc858af1838719a
                type: archive
                url: >-
                  https://download.gnome.org/sources/libsigc++/2.10/libsigc++-2.10.8.tar.xz
                x-checker-data:
                  type: gnome
                  name: libsigc++
                  //: later versions are incompatible with gtkmm3.24
                  versions:
                    <: '2.11'
            buildsystem: meson
            config-opts:
              - -Dbuild-examples=false
          - name: glibmm
            sources:
              - sha256: 64f11d3b95a24e2a8d4166ecff518730f79ecc27222ef41faf7c7e0340fc9329
                type: archive
                url: https://download.gnome.org/sources/glibmm/2.66/glibmm-2.66.8.tar.xz
                x-checker-data:
                  type: gnome
                  name: glibmm
                  //: later versions have ABI break
                  versions:
                    <: '2.67'
            buildsystem: meson
            config-opts:
              - -Dbuild-examples=false
          - name: cairomm
            sources:
              - sha256: 70136203540c884e89ce1c9edfb6369b9953937f6cd596d97c78c9758a5d48db
                type: archive
                url: https://www.cairographics.org/releases/cairomm-1.14.5.tar.xz
                x-checker-data:
                  type: anitya
                  project-id: 7959
                  url-template: https://www.cairographics.org/releases/cairomm-$version.tar.xz
                  versions:
                    <: '1.15'
            buildsystem: meson
            config-opts:
              - -Dbuild-examples=false
          - name: pangomm
            sources:
              - sha256: b92016661526424de4b9377f1512f59781f41fb16c9c0267d6133ba1cd68db22
                type: archive
                url: https://download.gnome.org/sources/pangomm/2.46/pangomm-2.46.4.tar.xz
                x-checker-data:
                  type: gnome
                  name: pangomm
                  versions:
                    <: '2.47'
            buildsystem: meson
          - name: atkmm
            sources:
              - sha256: 0a142a8128f83c001efb8014ee463e9a766054ef84686af953135e04d28fdab3
                type: archive
                url: https://download.gnome.org/sources/atkmm/2.28/atkmm-2.28.4.tar.xz
                x-checker-data:
                  type: gnome
                  name: atkmm
                  versions:
                    <: '2.29'
            buildsystem: meson

      - name: gtksourceviewmm
        config-opts:
          - --disable-documentation
        modules:
          - name: gtkspellmm
            config-opts:
              - --disable-documentation
            modules:
              - name: gtkspell3
                config-opts:
                  - --disable-documentation
                sources:
                  - type: archive
                    url: https://downloads.sourceforge.net/gtkspell/gtkspell3-3.0.10.tar.xz
                    sha256: b040f63836b347eb344f5542443dc254621805072f7141d49c067ecb5a375732
                    x-checker-data:
                      type: anitya
                      project-id: 13111
                      stable-only: true
                      url-template: https://downloads.sourceforge.net/gtkspell/gtkspell3-$version.tar.xz

            sources:
              - type: archive
                url: https://downloads.sourceforge.net/gtkspell/gtkspellmm-3.0.5.tar.xz
                sha256: 5b875a5753ce593274d0c6e803af6300973020c5443905999aba96ed3cef1545
                x-checker-data:
                  type: anitya
                  project-id: 353541
                  stable-only: true
                  url-template: https://downloads.sourceforge.net/gtkspell/gtkspellmm-$version.tar.xz

          - name: gtksourceview
            config-opts:
              - --disable-documentation
            sources:
              - type: archive
                url: https://download.gnome.org/sources/gtksourceview/3.24/gtksourceview-3.24.11.tar.xz
                sha256: 691b074a37b2a307f7f48edc5b8c7afa7301709be56378ccf9cc9735909077fd
                x-checker-data:
                  type: gnome
                  name: gtksourceview
                  stable-only: true
                  versions:
                    <: '3.25'
              - type: patch
                path: patches/gtksourceview-gcc14.patch
        sources:
          - type: archive
            url: https://download.gnome.org/sources/gtksourceviewmm/3.21/gtksourceviewmm-3.21.3.tar.xz
            sha256: dbb00b1c28e0407cc27d8b07a2ed0b4ea22f92e4b3e3006431cbd6726b6256b5
            x-checker-data:
              type: gnome
              name: gtksourceviewmm
              stable-only: true
              versions:
                <: '3.22'

      - name: poppler
        config-opts:
          - -DENABLE_ZLIB=ON
          - -DENABLE_LIBTIFF=ON
          - -DENABLE_LIBPNG=ON
          - -DENABLE_GLIB=ON
          - -DENABLE_QT5=OFF
          - -DENABLE_QT6=OFF
          - -DENABLE_CMS='lcms2'
          - -DENABLE_LIBOPENJPEG='openjpeg2'
          - -DENABLE_DCTDECODER='libjpeg'
          - -DENABLE_SPLASH=OFF
          - -DENABLE_BOOST=OFF
          - -DENABLE_CPP=OFF
        buildsystem: cmake-ninja
        builddir: true
        modules:
          - name: openjpeg2
            buildsystem: cmake-ninja
            builddir: true
            cleanup:
              - /bin
            sources:
              - type: archive
                url: https://github.com/uclouvain/openjpeg/archive/v2.5.3.tar.gz
                sha256: 368fe0468228e767433c9ebdea82ad9d801a3ad1e4234421f352c8b06e7aa707
                x-checker-data:
                  type: anitya
                  project-id: 2550
                  stable-only: true
                  url-template: https://github.com/uclouvain/openjpeg/archive/v$version.tar.gz
        sources:
          - type: archive
            url: https://poppler.freedesktop.org/poppler-25.08.0.tar.xz
            sha256: 425ed4d4515a093bdcdbbaac6876f20617451edc710df6a4fd6c45dd67eb418d
            x-checker-data:
              type: anitya
              project-id: 3686
              stable-only: true
              url-template: https://poppler.freedesktop.org/poppler-$version.tar.xz

      - name: libxml++
        config-opts:
          - --disable-documentation
        sources:
          - type: archive
            url: https://download.gnome.org/sources/libxml++/3.2/libxml++-3.2.5.tar.xz
            sha256: 0c9b381b5a83d6b3ab4b0b865d7256dab27d575981b63be2f859edcb94da59c7
            x-checker-data:
              type: gnome
              name: libxml++
              stable-only: true
              versions:
                <: '3.3'

      - name: libzip
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_INSTALL_LIBDIR=/app/lib
          - -DCMAKE_INSTALL_INCLUDEDIR=/app/include
        cleanup:
          - /bin
        sources:
          - type: archive
            url: https://libzip.org/download/libzip-1.11.4.tar.xz
            sha256: 8a247f57d1e3e6f6d11413b12a6f28a9d388de110adc0ec608d893180ed7097b
            x-checker-data:
              type: anitya
              project-id: 10649
              url-template: https://libzip.org/download/libzip-$version.tar.xz

      - name: tesseract
        buildsystem: autotools
        config-opts:
          - --disable-graphics
        modules:
          - name: libleptonica
            buildsystem: autotools
            sources:
              - type: archive
                url: https://github.com/DanBloomberg/leptonica/releases/download/1.85.0/leptonica-1.85.0.tar.gz
                sha256: 3745ae3bf271a6801a2292eead83ac926e3a9bc1bf622e9cd4dd0f3786e17205
                x-checker-data:
                  type: anitya
                  project-id: 1549
                  url-template: https://github.com/DanBloomberg/leptonica/releases/download/$version/leptonica-$version.tar.gz

        sources:
          - type: archive
            url: https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.5.1.tar.gz
            sha256: a7a3f2a7420cb6a6a94d80c24163e183cf1d2f1bed2df3bbc397c81808a57237
            x-checker-data:
              type: anitya
              project-id: 4954
              url-template: https://github.com/tesseract-ocr/tesseract/archive/refs/tags/$version.tar.gz

      # The `tessdata_fast` variant is recommended for end users: https://tesseract-ocr.github.io/tessdoc/Data-Files
      - name: tessdata_fast
        buildsystem: simple
        build-commands:
          - rm -rf ${FLATPAK_DEST}/share/tessdata
          - mkdir -p ${FLATPAK_DEST}/share/tessdata
          - cp -av * ${FLATPAK_DEST}/share/tessdata/
        sources:
          - type: git
            url: https://github.com/tesseract-ocr/tessdata_fast
            tag: 4.1.0
            commit: 65727574dfcd264acbb0c3e07860e4e9e9b22185
            x-checker-data:
              type: anitya
              project-id: 326567
              tag-template: $version

      - name: enchant
        sources:
          - type: archive
            url: https://github.com/AbiWord/enchant/releases/download/v2.8.12/enchant-2.8.12.tar.gz
            sha256: 20e5fab2ca0f95ba9d1ef5052fe5b028e3e1d66d4cdea6b9adfcbd3e524c2a09
            x-checker-data:
              type: anitya
              project-id: 6601
              stable-only: true
              url-template: https://github.com/AbiWord/enchant/releases/download/v$version/enchant-$version.tar.gz
        cleanup:
          - '*.a'
          - '*.la'
          - /bin
          - /include
          - /share

    sources:
      - type: git
        url: https://github.com/manisandro/gimagereader
        tag: v3.4.3
        commit: 8b9c9fb7389d9ca9c5086bef15665db8268eb21e
        x-checker-data:
          type: anitya
          project-id: 8889
          stable-only: true
          tag-template: v$version
      - type: patch
        paths:
          - patches/fix-about-dialog-logo.patch
